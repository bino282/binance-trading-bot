# config/pairs/BNBUSDT_TEMPLATE.yaml
# 3-Tier Hybrid Trading Bot v1.1.3 — Pair Config (BNB/USDT) with MTF & Score-Driven Support
# Profile B — Flexible (VI) — Chính sách cấp cặp: tham số chỉ báo, ngưỡng Score, MTF gating, Arbiter, policy theo kịch bản.
# Enhanced với Score Engine và Multiple Time Frame capabilities
# Market filters và strategy parameters dựa trên volatility analysis từ 14-day historical data
# Lưu ý: verify tick_size/lot_size/min_notional qua Binance exchangeInfo trước khi live.

# ===== Core (root-level, bắt buộc) =====

pair:
  symbol: ZECUSDT
  runtime: backtest          # backtest | live  (scripts có thể override bằng env.yaml)
  testnet: true              # true: Binance Testnet, false: Mainnet
  base : ZEC
  quote: USDT

market_filters:                  # BẮT BUỘC: dùng cho precision & kiểm soát đơn hàng
  tick_size: 0.01                # Bước giá tối thiểu (giá phải là bội số của tick_size)
  lot_size: 0.001                # Bước khối lượng tối thiểu (khối lượng phải là bội số của lot_size)
  min_notional: 5.0              # Giá trị tối thiểu của đơn hàng (giá * khối lượng ≥ min_notional)

starting_cash_usdt: 3000.0       
order_size_quote_usdt: 90.0    # Optimized cho ZEC dựa trên volatility analysis (volatility factor: 0.73)
fee_per_leg_pct: 0.001          # 0.1% mỗi chiều (BUY/SELL)

# ===== Runtime common =====
runtime_cfg:
  kline_interval: "5m"     # 5m base timeframe cho ZEC
  main_loop_ms: 500
  reconcile_sec: 120

# ===== Score-Driven Engine Overrides =====
score_engine:
  enabled: true
  log_detailed_scores: true              # Enable detailed score logging for backtest analysis

# ---------- Score-driven Features ----------
features:
  # Bật/Tắt Score Layer, Arbiter và shadow_mode
  shadow_mode: false                       # Tính & ghi log Score nhưng KHÔNG can thiệp đặt lệnh
  score_layer_enabled: true                # Bật Score Layer ở cấp môi trường
  arbiter_enabled: true                    # Bật Arbiter (giải quyết xung đột tín hiệu)

# ===== MTF Engine Overrides =====  
# ---------- Multiple Time Frames (MTF) ----------
mtf:
  # Cài đặt Multiple Time Frames (MTF)
  enabled: true
  htfs:                                    # Higher timeframes to analyze (legacy)
    - "10m"
    - "15m" 
    - "30m"
    - "1h"
    - "4h"
  higher_timeframes: ["10m", "15m", "30m", "1h", "4h"]  # HTFs for 5m base timeframe
  bar_close_only: true                     # Chỉ xử lý khi nến đã ĐÓNG (tránh look-ahead)
  gate_entry_tfs:                          # HTF timeframes that can gate entry signals
    - "15m"
    - "30m"
  require_alignment: true                  # Nếu true, Entry 5m cần sự đồng thuận từ HTF
  
# ===== Arbiter Engine Overrides =====
arbiter:
  enabled: true

# ===== Enhanced Policy Configuration with MTF & Score Support =====
policy_cfg:
  # Decision engine mode: "legacy", "score_driven", "hybrid"
  decision_mode: "hybrid"
  
  # Tham số hoá TSI/Stochastic RSI/cửa sổ Flow…
  indicators:
    warmup_bars: 300          # Giữ nguyên cho đủ data
    rsi_length: 14
    ema_fast: 34
    ema_mid: 89
    ema_slow: 200
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    adx_length: 14
    atr_length: 14
    bb_length: 20
    bb_std: 2.0
    cmf_length: 20
    use_vwap: true
    # Enhanced indicators for Score Engine
    tsi:
      r: 25
      s: 13
      signal: 7
    stochrsi:
      length: 14
      smooth_k: 3
      smooth_d: 3
    flow_windows:
      adi_slope: 34
      obv_slope: 34
      z_window: 50
    bb_width_pctile_window: 200
    macd_hist_z_window: 50

  spread_engine:
    mode: dynamic
    fixed_spread_pct: 0.0034             # BNB average volatility 0.38% - fallback spread
    bands:
      near:
        atr_pct_max: 0.0031               # BNB Near ATR threshold 0.30%
        rsi_soft_min: 40
        rsi_soft_max: 60
        spread_pct: [0.0030, 0.0036]     # BNB Near Band: 0.28%-0.36% spread range
      mid:
        atr_pct_min: 0.0031               # Above near threshold
        atr_pct_max: 0.0048               # BNB Mid ATR threshold 0.50%
        rsi_soft_min: 30                 # RSI parameters for mid band
        rsi_soft_max: 70
        spread_pct: [0.0036, 0.0044]     # BNB Mid Band: 0.36%-0.49% spread range
      far:
        atr_pct_min: 0.0048               # Above mid threshold
        rsi_soft_min: 25                 # Far band RSI parameters - wider range for high volatility
        rsi_soft_max: 75
        spread_pct: [0.0044, 0.0056]     # BNB Far Band: 0.49%-0.76% spread range

    rsi_adjust:
      oversold_boost: 0.0002
      overbought_relax: -0.0001

  grid:
    enable: true
    spacing_mode: use_band_median
    fixed_spacing_pct: 0.0034           # BNB Grid spacing 0.36% - optimized for volatility
    levels_per_side: 7                  # BNB recommended 7 levels per side
    degraded_levels_per_side: 3           # Grid levels when PnL Gate in DEGRADED state
    kill_replace:
      enable: true
      price_deviation_pct: 0.011       # price_deviation_pct nghĩa là nếu lệnh không được fill và giá di chuyển > 1.1% thì hủy và đặt lại lệnh
      min_seconds_between: 120

  dca:
    enable: true
    rsi_threshold_buy: 38               # nghĩa là RSI < 38 mới DCA (tăng từ 36 → 38 cho ZEC)
    ema_filter:
      require_price_above_ema_fast: false
      require_price_above_ema_mid: false
    allocation_plan:
      steps_max: 3
      steps_pct: [0.18, 0.20, 0.25]     # ZEC-optimized: tăng allocation (ZEC ổn định hơn)
      cooldown_bars: 6                   # cooldown_bars nghĩa là sau khi DCA thì phải đợi 6 bars mới được DCA tiếp
    safety_guards:
      min_distance_from_last_fill_pct: 0.0055  # nghĩa là phải cách 0.55% so với lệnh DCA trước đó mới đặt lệnh tiếp

  tp_trailing:
    enable: true
    by_band:
      near:
        trigger_pct: 0.0030              # BNB Near: trigger=0.23%, trail=0.13%
        trail_pct: 0.0012                 # Optimized for BNB volatility
      mid:
        trigger_pct: 0.0036              # BNB Mid: trigger=0.30%, trail=0.19%
        trail_pct: 0.0016                 # Optimized for BNB volatility
      far:
        trigger_pct: 0.0042              # BNB Far: trigger=0.46%, trail=0.27%
        trail_pct: 0.0020                 # BNB Far trail optimized for volatility
    min_hold_bars: 3                     # ZEC-optimized: tăng từ 2 → 3 (ZEC ít swing hơn)
    profit_taking:
      overbought_relax: -0.0002       # RSI > 65 → -0.02% để dễ chốt lời

  pnl_gate:
    enable: true
    # ZEC-optimized thresholds - moved to policy_cfg.pnl_gate for proper priority
    # NEW: UTC Daily Reset Configuration - ZEC-specific
    utc_daily_reset:
      enable: true                        # Bật tính năng reset hàng ngày cho ZEC
      persistence_file: "daily_state_ZECUSDT.json"  # File riêng cho ZEC pair
      enable_persistence: true            # Lưu trạng thái qua restart bot
    # ZEC-optimized thresholds (override base.yaml defaults)
    degrade_daily_pnl_pct: -0.0040        # degrade_daily_pnl_pct nghĩa là khi lỗ -1.0% thì chuyển sang trạng thái DEGRADED
    degrade_gap_pct: 0.0040                # degrade_gap_pct nghĩa là khi trong ngày giá giảm ≥ 1.2% thì chuyển sang trạng thái DEGRADED
    pause_gap_pct: 0.0070                  # pause_gap_pct nghĩa là khi trong ngày giá giảm ≥ 1.8% thì chuyển sang trạng thái PAUSED
    pause_daily_pnl_pct: -0.0050           # pause_daily_pnl_pct nghĩa là khi lỗ -1.5% thì chuyển sang trạng thái PAUSED
    drawdown_pause:
      enable: true
      max_drawdown_pct: 0.0065             # Bot tạm dừng khi drawdown > 1.2%
    gap_pause:
      gap_pct_X: 0.0070                    # LEGACY: Kept for backward compatibility (now redundant with pause_gap_pct)
    daily_pnl_pause:
      pnl_pct_Y: -0.0050                   # LEGACY: Kept for backward compatibility (now redundant with pause_daily_pnl_pct)
      require_price_below_open: true
    resume:
      min_recover_pnl_pct: -0.0020         # ZEC-optimized: tăng từ -0.030 → -0.025
      max_gap_pct: 0.0035                   # ZEC-optimized: giảm từ 0.015 → 0.012
    
    # Force sell when bot is paused and price drops (PnL Gate protection)
    # Synced from base.yaml - ZEC-specific optimizations
    force_sell:
      enable: true                       # Enable force sell on pause for ZEC
      price_drop_threshold_pct: 0.0030   # ZEC: Same as base (0.05% price drop triggers sell)
      min_pause_duration_sec: 0          # ZEC: Immediate (no delay)
      max_position_pct: 1.00             # ZEC: Sell 100% of position (aggressive protection)
      min_position_size: 0.0             # ZEC: No minimum (sell any size)
      market_order: true                 # ZEC: Use market order for fast execution

  sl_engine:
    enable: true
    # NEW: UTC Daily Reset Configuration - ZEC-specific
    utc_daily_reset:
      enable: true                        # Bật tính năng reset hàng ngày cho ZEC
      persistence_file: "sl_daily_state_ZECUSDT.json"  # File riêng cho ZEC pair
      enable_persistence: true            # Lưu trạng thái qua restart bot
    order_sl:
      enable: true
      # max_hold_minutes: 120               # comment lại vì không dùng
      # max_adverse_move_pct: 0.008        # Tạm comment lại
    capital_sl:
      enable: true
      hard_stop_daily_pnl_pct: -0.0070  # ZEC-optimized: strict hơn -0.035 → -0.030
      hard_stop_gap_pct: 0.0085         # nghĩa là nếu gap > 3.0% thì dừng luôn
      max_drawdown_pct: 0.0080          # Stop khi drawdown > 3.0%
      # NEW: Force sell on hard stop trigger (emergency liquidation)
      force_sell_on_stop:
        enable: true                   # Bật tự động bán khi Hard Stop trigger
        sell_percentage: 100.0         # Bán 100% vị thế (emergency exit)
        use_market_order: true         # Dùng market order để fill nhanh
        min_position_size: 0.0001      # Minimum base amount để thực hiện force sell
        # OPTIONAL: Retry configuration (tránh spam orders)
        retry_interval_sec: 10         # Không retry trong vòng dưới 10 giây
        max_retries: 3                 # Thử tối đa 3 lần nếu execution fail
    kill_switch:
      enable: true
      max_consecutive_losses: 3        # nghĩa là thua 3 lệnh liên tiếp thì dừng bot
  
  # ===== Market Filters for Strategy Gates =====
  filters_ta:
    grid_gate:
      require_adx_below: 28              # tránh bật Grid khi trend quá mạnh. Nhưng trạng thái trong codebase hiện tại đang là NOT IMPLEMENTED.
      vwap_distance_max_pct: 0.0043       # |price - VWAP| <= 0.43% tham số này nghĩa là tránh mua quá xa VWAP. Nhưng trạng thái trong codebase hiện tại đang là NOT IMPLEMENTED.
    dca_gate:
      rsi_threshold_buy: 38               # ZEC-optimized: giảm từ 38 → 37
      # prefer_price_below_ema_mid: true    # prefer_price_below_ema_mid nghĩa là ưu tiên DCA khi giá dưới EMA mid
    tp_gate:
      require_macd_hist_down_for_sell: false  # require_macd_hist_down_for_sell nghĩa là chỉ bán khi MACD histogram đang giảm. Nhưng trạng thái trong codebase hiện tại đang là NOT IMPLEMENTED.

  # ===== Score Layer Configuration =====
  score_layer:
    enabled: true
    shadow_mode: false                  # false = score-driven mode, true = shadow mode
    # Ngưỡng per-scenario (Entry/Hold/Exit) cho ZEC/USDT
    thresholds:
      '#1':                            # Strong uptrend - ZEC-optimized: cần confirmation cao hơn
        entry: 68                      # Tăng từ 65 → 68
        hold: 58                       # Tăng từ 55 → 58
        exit: 48                       # Tăng từ 45 → 48
      '#2':                            # Momentum breakout - ZEC responsive
        entry: 62
        hold: 52
        exit: 42
      '#3':                            # OverZECd bounce - ZEC good rebound
        entry: 65
        hold: 55
        exit: 45
      '#4':                            # Volume accumulation - ZEC volume patterns
        entry: 70
        hold: 58
        exit: 48
      '#5':                            # Pullback entry - ZEC trend following
        entry: 68
        hold: 56
        exit: 50
      '#6':                            # Volatility contraction - ZEC prep for move
        entry: 64
        hold: 54
        exit: 46
      '#7':                            # Mean reversion - ZEC có mean reversion tốt
        entry: 75                      # ZEC-optimized: tăng từ 72 → 75 (ZEC stable hơn)
        hold: 62                       # Tăng từ 58 → 62
        exit: 52                       # Tăng từ 50 → 52
      '#8':                            # Momentum divergence - ZEC divergence signals
        entry: 70
        hold: 60
        exit: 48
      '#9':                            # ConZECidation breakout - ZEC breakout specialist
        reduce_or_exit: 65
        pause_buy: 55
    
    bonus_penalty:
      htf_alignment:
        m10_m15: [4, 8]                # Moderate bonus for short-term HTF alignment
        m30_h1: [8, 15]                # Strong bonus for longer HTF alignment
        conflict: [-20, -10]           # Heavy penalty for HTF conflicts
      retest_ok: [8, 10]               # Bonus for successful retests
      fail_breakout: [-15, -12]        # Penalty for failed breakouts  
      flow_bias: [-8, 8]               # Volume flow bias adjustment
    
    hysteresis:
      cooldown_bars_5m: 5             # ZEC-optimized: tăng từ 2 → 3 bars (ZEC ổn định hơn)

  # ===== MTF Configuration =====
  mtf:
    htfs: ["10m", "15m", "30m", "1h", "4h"]  # Higher timeframes to analyze - synced with env.yaml
    bar_close_only: true               # Only process on bar close to avoid look-ahead
    # [DISABLED 02.11.2025 - HTF Gating Removal]
    # gate_entry_tfs: ["15m", "30m"]     # These timeframes can gate entry signals
    # require_alignment: true            # Require HTF alignment for entry

  # ===== Arbiter Configuration =====
  arbiter:
    enabled: true
    precedence:                        # Signal precedence order (highest to lowest)
      - "exit_reduce"                  # Exit/reduce signals have highest priority
      - "tp_trailing"                  # Take profit trailing signals
      - "entry_new"                    # New entry signals
      - "dca"                         # DCA signals lowest priority
    dedup_one_entry_per_5m: true      # Deduplicate multiple entries per bar
    cancel_children_on_reversal: true  # Cancel pending orders on signal reversal
    hysteresis:
      cooldown_bars_5m: 5             # Hysteresis cooldown

  # ===== Scenario-based Policy Overrides =====
  scenario_policy:
    '#1':                            # Strong uptrend policy
      spread_adjust_bps: -4          # Tighter spreads for trending
      grid:
        enable: true
        levels_per_side: 7           
      dca:
        enable: true
      size_factor: 1.0
    
    '#2':                            # Momentum breakout policy nghĩa là giá bứt phá mạnh
      spread_adjust_bps: -2
      grid:
        enable: true
        levels_per_side: 6           # ZEC-optimized: giảm từ 7 → 6 levels (để phản ứng nhanh hơn với biến động mạnh)
      dca:
        enable: true
      size_factor: 1.0
    
    '#3':                            # OverZECd bounce policy
      spread_adjust_bps: 0
      grid:
        enable: false                # Disable grid for bounce trades
      dca:
        enable: true
      size_factor: 1.05              # Slightly larger size for bounces
    
    '#4':                            # Volume accumulation policy
      spread_adjust_bps: 3
      grid:
        enable: false
      dca:
        enable: false
      size_factor: 1.1               # Larger size for volume breakouts
    
    '#5':                            # Pullback entry policy nghĩa là giá hồi về
      spread_adjust_bps: 2
      grid:
        enable: true
        levels_per_side: 3           # Minimal grid for pullbacks
      dca:
        enable: true
      size_factor: 0.9
    
    '#6':                            # #6 là kịch bản giá co hẹp chuẩn bị cho biến động lớn
      spread_adjust_bps: 0
      grid:
        enable: true
        levels_per_side: 3           # ZEC-optimized: giảm từ 5 → 4 levels (để phản ứng nhanh hơn với biến động mạnh)
      dca:
        enable: true
      size_factor: 0.95
    
    '#7':                            # Mean reversion policy
      spread_adjust_bps: 4
      grid:
        enable: false                # No grid for mean reversion
      dca:
        enable: false
      size_factor: 0.8               # Smaller size for mean reversion
    
    '#8':                            # Momentum divergence policy
      spread_adjust_bps: 5
      grid:
        enable: false
      dca:
        enable: false
      size_factor: 0.85
    
    '#9':                            # ConZECidation breakout policy
      spread_adjust_bps: 6
      grid:
        enable: false
      dca:
        enable: false
      size_factor: 0.75              # Conservative size for breakouts

# ===== Logging (Safe Mode) =====
logging:
  safe_mode:
    enable: true
    level: INFO
    rotate_minutes: 15
    channels:
      orders: true
      risk: true
      summary: true
      fills: true
      ticks: false